# 通讯协议和格式约定

与服务器通讯是这个程序的核心功能之一，让我们看一下怎样与服务器沟通吧！

## 快速跳转

- [通讯协议和格式约定](#通讯协议和格式约定)
  - [快速跳转](#快速跳转)
  - [概念](#概念)
  - [REP协议版本列表](#rep协议版本列表)
  - [REP协议 V1](#rep协议-v1)
    - [数据包](#数据包)
    - [结构总览](#结构总览)
    - [数据包所用协议版本](#数据包所用协议版本)
    - [功能码/状态码](#功能码状态码)
    - [数据包的功能ID和状态ID](#数据包的功能id和状态id)

## 概念

RemoteExecutor的通讯协议名称为"RemoteExecutor Protocol"，简称为REP。

协议版本用于判断服务端和客户端是否兼容，该版本使用一个正整数表示。

## REP协议版本列表

**注：除有特殊说明的版本外，程序在默认情况下只允许使用某一个协议版本，不能兼容其他版本。**

|版本   |最低客户端版本|最低服务端版本|最低受控端版本|备注                     |
|-------|--------------|-------------|--------------|------------------------|
|1      |1.0.0         |1.0.0        |1.0.0         | |

## REP协议 V1

### 数据包

**数据包是RemoteExecutor中通过WebSocket进行网络通讯的基本单位。**
### 结构总览

数据包是由以下几部分构成的：

|地址|类型|说明|
|----|----|----|
|0x00|uint16|数据包所用协议版本|
|0x02|uint128|令牌(若当前没有令牌则为0)|
|0x0A|uint64|操作码和数据等的摘要|
|0x0E|uint16|功能码/状态码|
|0x10|uint16|状态额外信息|
|0x02|uint32|数据包的数据类型|
|0x16|uint32|报文本体长度|
|0X1A|-|报文本体|

### 数据包所用协议版本

在REP V1中，它的值应该为`1`(`0x1`)

### 功能码/状态码

### 数据包的功能ID和状态ID

|ID|说明|额外信息|报文|
|---|---|---|---|
|100|就绪|||
|101|心跳|||
|102|请求重新发送上个数据包|||
|103|协议版本不受支持|||
|104|请求切换协议|协议版本||
|105|发送认证信息|类型(公钥/客户端加密凭据/服务器发送令牌)|认证信息|
|106|登录超时|||
|107|登录成功|||
|108|登录失败||原因|
|109|用户主动登出||原因|
|110|服务器强制登出||原因|
|111|要求重新提交验证信息||原因|
|112|权限不足|要求的最低权限级别||
|200|传输成功||传输的数据(可选)|
|201|分片传输成功|分片序号|传输的数据(可选)|
|202|操作成功|操作功能码|返回数据(可选)|
|202|请求对方发送用户基本信息||
|203|发送用户基本信息||数据|
|204|请求对方发送配置信息|||
|205|发送配置信息||数据|
|300|数据包语法错误||原因|
|301|数据包数据类型未定义|||
|302|不受支持的操作/状态码未定义|||
|400|客户端忙|||
|401|客户端发生内部错误||错误信息|
|500|服务器忙|||
|501|服务器发生内部错误||错误信息|
|600|列出目录||路径|
|601|上传文件|旧文件处理方式|路径|
|602|下载文件||路径|
|603|查询文件是否存在||路径|
|604|获取文件类型|||
|604|复制文件|复制方式|源路径和目标路径|
|605|移动/重命名文件|移动方式|源路径和目标路径|
|606|执行控制台命令||命令文本|
|607|截屏|||
|700|没有这个文件或目录|||
|701|文件系统访问权限不足|||
|702|文件访问出错||错误原因|
|703|非法的文件名|||
|704|路径语法错误|||

TODO
